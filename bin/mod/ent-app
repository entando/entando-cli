#!/bin/bash

[[ "$1" == "--help" && "$2" == "--short" ]] && {
  echo -e "Helps managing an EntandoApp" && exit 0
}

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" > /dev/null 2>&1 && pwd)"
cd "$DIR/../.." || {
  echo "Internal error: unable to find the script source dir" 1>&2
  exit
}

. s/_base.sh

RUN() {
  HH="$(parse_help_option "$@")"
  show_help_option "$HH" "the base command"
  args_or_ask ${HH:+"$HH"} -a -n -- "CMD" '1///%sp command' "$@"

  args_or_ask ${HH:+"$HH"} -n -p NAMESPACE "--namespace/ext_ic_id//%sp the kubernetes namespace" "$@"

  [[ -n "$HH" && -z "$CMD" ]] && exit

  show_help_option "$HH" "\"$CMD\""

  case "$CMD" in
    "images")
      print_images "$@"
      ;;
    "configmap")
      print_configmap "$@"
      ;;
    "info")
      [ -n "$HH" ] && exit 0
      shift
      ent app-info "$@"
      ;;
    "")
      "${BASH_SOURCE[0]}" "--help"
      ;;
    *)
      [ -n "$HH" ] && exit 0
      FATAL "Unknown command \"$CMD\""
      ;;
  esac
}

print_configmap() {
  [ -n "$HH" ] && exit 0
  _kubectl ${NAMESPACE:+-n "$NAMESPACE"} get configmap "entando-docker-image-info" -o yaml \
    | perl -p0e 's/.*\n(data:.*)/\1/msg' | perl -p0e 's/\n[^ ].*//msg'
}

print_images() {
  local FILTER="$ENTANDO_IMAGES_FILTER"
  args_or_ask ${HH:+"$HH"} -n -f '--all/// prints all the images' "$@" && {
    FILTER=".*"
  }

  [ -n "$HH" ] && exit 0
  # shellcheck disable=SC2021 disable=SC2155
  local RES=$(
    _kubectl ${NAMESPACE:+-n "$NAMESPACE"} get pods -o jsonpath="{..image}" \
      | \tr -s '[[:space:]]' '\n' | \sort -u \
      | \grep "$FILTER"
  )
  [ -z "$RES" ] && FATAL "Unable fetch the images list"

  echo "$RES"
  echo ""
  if $OS_WIN; then
    echo "$RES" | sha256sum
  else
    echo "$RES" | shasum -a 256
  fi
}

select_app_ctx() {
  # shellcheck disable=SC2034
  local application_context RES
  local apps_base_dir="$ENTANDO_HOME/apps/"

  (
    __cd "$apps_base_dir"
    # shellcheck disable=SC2035
    map-from-stdin "application_context" $'\n\r' < <(ls -d *)

    args_or_ask__a_map "application_context" -a ${HH:+"$HH"} "APP_CTX" "1" "Select the application context" "$@"
    local app_dir="$ENTANDO_HOME/apps/$APP_CTX/"

    if [ ! -d "$app_dir" ]; then
      _log_w 0 "Application context \"$APP_CTX\" not found"
      _log_i 0 "Application context \"$APP_CTX\" created"
      $AUTO_YES || ask "Should I create it?" || EXIT_UE "User interrupted"
      mkdir -p "${app_dir}"
      cp -r "$ENT_WORK_DIR" "${app_dir}" || true
      _log_i 0 "Current configuration and state imported under \"$APP_CTX\""
    fi

    save_cfg_value "THIS_APP_CTX" "${APP_CTX}"
    save_cfg_value "ENTANDO_CURRENT_APP_CTX" "${APP_CTX}" "$ENTANDO_GLOBAL_CFG"
    save_cfg_value "ENTANDO_CURRENT_APP_CTX_HOME" "${app_dir}" "$ENTANDO_GLOBAL_CFG"
  )
  reload_cfg "$ENTANDO_GLOBAL_CFG"
  activate_application_workdir
}

delete_app_ctx() {
  # shellcheck disable=SC2034
  local application_context RES
  local apps_base_dir="$ENTANDO_HOME/apps/"

  (
    __cd "$apps_base_dir"
    # shellcheck disable=SC2035
    args_or_ask__a_map "application_context" -a ${HH:+"$HH"} "APP_CTX" "1" "Select the application context" "$@"
    [ ! -d "$APP_CTX" ] && FATAL "Application not found"
    [ ! -d "$APP_CTX/w" ] && FATAL "Invalid application context dir"
    _log_w 0 "Application context \"$APP_CTX\" found"
    $AUTO_YES || ask "Should I really delete it?" || EXIT_UE "User interrupted"
    rm -rf "$APP_CTX"
    _log_i 0 "Application context \"$APP_CTX\" deleted"

    save_cfg_value "THIS_APP_CTX" ""
    save_cfg_value "ENTANDO_CURRENT_APP_CTX" "" "$ENTANDO_GLOBAL_CFG"
    save_cfg_value "ENTANDO_CURRENT_APP_CTX_HOME" "" "$ENTANDO_GLOBAL_CFG"
    true
  ) && {
    reload_cfg "$ENTANDO_GLOBAL_CFG"
    _log_i 0 "Switched to the default application context"
  }
}

ENTANDO_IMAGES_FILTER=""
ENTANDO_IMAGES_FILTER+="entando-component-manager\|"
ENTANDO_IMAGES_FILTER+="entando-de-app-wildfly\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-app-controller\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-app-plugin-link-controller\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-cluster-infrastructure-controller\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-composite-app-controller\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-controller-coordinator\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-dbjob\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-keycloak-controller\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-plugin-controller\|"
ENTANDO_IMAGES_FILTER+="entando-k8s-service\|"
ENTANDO_IMAGES_FILTER+="entando-keycloak\|"
ENTANDO_IMAGES_FILTER+="entando-plugin-sidecar"

RUN "$@"