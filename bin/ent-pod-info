#!/bin/bash

[ "$1" = "-h" ] && echo -e "Displays infomations related to a set of pods | Syntax: ${0##*/} namespace pod-name-pattern" && exit 0

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" > /dev/null 2>&1 && pwd)"
cd "$DIR/.." || {
  echo "Internal error: unable to find the script source dir" 1>&2
  exit
}

. s/_base.sh

ENTANDO_NAMESPACE="$1"
[ "$ENTANDO_NAMESPACE" == "" ] && echo "please provide the namespace name" 1>&2 && exit 1
shift

POD_PATT="$1"
[ "$POD_PATT" == "" ] && echo "please provide the pod pattern" 1>&2 && exit 1
shift

ensure_sudo

for pod in $($KUBECTL get pods -n "$ENTANDO_NAMESPACE" | awk 'NR>1' | awk '{print $1}' | grep "$POD_PATT"); do
  echo -e "===\n====================================================================================================\n==="
  echo "> POD: $pod"
  $KUBECTL describe pods/"$pod" -n "$ENTANDO_NAMESPACE"
  for co in $($KUBECTL get pods/"$pod" -o jsonpath='{.spec.containers[*].name}{"\n"}' -n "$ENTANDO_NAMESPACE"); do
    echo -e "~~~\n~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n~~~"
    echo -e ">\tCONTAINER: $co"
    $KUBECTL logs pods/"$pod" -c "$co" -n "$ENTANDO_NAMESPACE"
  done
done
