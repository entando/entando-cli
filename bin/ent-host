#!/bin/bash

H() { echo -e "Helps managing the system that hosts the quickstart VM | Syntax: ${0##*/} update-hosts-file ..."; }
[ "$1" = "-h" ] && H && exit 0

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" > /dev/null 2>&1 && pwd)"
cd "$DIR/.." || {
  echo "Internal error: unable to find the script source dir" 1>&2
  exit
}

RUN() {
  case "$1" in
    "fix-vm-ddns")
      shift
      local VM_NAME
      #---
      args_or_ask -n -f '--help' "$@" && {
        local HH="-h"
        echo "> Parameters:"
      }

      if [ -n "$DESIGNATED_VM" ]; then
        args_or_ask -a $HH "VM_NAME" "1/ext_id//VM NAME" "$@" || FATAL "Unable to determine the VM name"
      else
        VM_NAME="$DESIGNATED_VM"
      fi
      args_or_ask $HH -n RELEASE  '--release/any?//Optional ent version' "$@"

      [ -n "$HH" ] && return 0

      #---
      [ -z "$RELEASE" ] && {
        local ENTS=("$(multipass exec "$VM_NAME" -- bash -c "ls ~/.entando/ent")")

        case "${#ENTS[@]}" in
          0) FATAL "No ent found in VM";;
          1) local RELEASE="${ENTS[0]}";;
          *) select_one "Select the release" "${ENTS[@]}" && RELEASE="$select_one_res_alt";;
        esac
      }

      #---
      # shellcheck disable=SC2016
      local ADDR="$(multipass exec "$VM_NAME" -- hostname -I | awk '{print $1}')"
      local CFG=$(multipass exec "$VM_NAME" -- bash -c '. .entando/ent/'"$RELEASE"'/cli/*/w/.cfg && echo "$ENTANDO_NAMESPACE;$ENTANDO_APPNAME;$ENTANDO_SUFFIX"')

      IFS=';' read -r -a CFG_ARR <<< "$CFG"
      set_nn_dn "ENTANDO_NAMESPACE" "${CFG_ARR[0]}"
      set_nn_dn "ENTANDO_APPNAME" "${CFG_ARR[1]}"
      set_nn_fdn "ENTANDO_SUFFIX" "${CFG_ARR[2]}"

      _log_i 0 "In VM: $VM_NAME"
      _log_i 0 "Found NAMESPACE: $ENTANDO_NAMESPACE"
      _log_i 0 "Found APPNAME: $ENTANDO_APPNAME"
      _log_i 0 "Found SUFFIX: $ENTANDO_SUFFIX"

      if [ "$ENTANDO_SUFFIX" = "$ADDR.nip.io" ]; then
        _log_w 0 "The suffix configured in the VM seems to be aligned, no need to fix DNS"
        FATAL "Unnecessary operation"
      fi

      _log_i 1 "Setting host file entries for VM \"$VM_NAME\" with address \"$ADDR\""

      hostsfile_clear "$VM_NAME"
      hostsfile_add_dns "$ADDR" "$ENTANDO_APPNAME-$ENTANDO_NAMESPACE.$ENTANDO_SUFFIX" "$VM_NAME"
      hostsfile_add_dns "$ADDR" "$ENTANDO_APPNAME-kc-$ENTANDO_NAMESPACE.$ENTANDO_SUFFIX" "$VM_NAME"

      _log_i 1 "Done"

      ask "Do you want to restart the VM?" Y && {
        multipass restart "$VM_NAME"
      }

      _log_i 1 "Operation completed"
      ;;
    *)
      FATAL "unknown options"
      ;;
  esac
}

. s/_base.sh

RUN "$@"
